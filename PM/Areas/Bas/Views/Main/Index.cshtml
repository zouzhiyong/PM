@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/Content/bootstrap-table.min.css" rel="stylesheet" />
<link href="~/Content/bootstrap-datepicker3.css" rel="stylesheet" />
<script type="text/javascript" src="~/Scripts/bootstrap-table.min.js"></script>
<script type="text/javascript" src="~/Scripts/bootstrap-table-zh-CN.min.js"></script>
<script type="text/javascript" src="~/Scripts/bootstrap-datepicker.min.js"></script>
<script type="text/javascript" src="~/Scripts/locales/bootstrap-datepicker.zh-CN.min.js"></script>
<style>
    td, span, div { font-size: 12px; }
    .bootstrap-table .table { table-layout: fixed;max-width: 2000px; }
    .fixed-table-container, .bootstrap-table .table { border-radius: 0; table-layout: fixed; }
        .bootstrap-table .table th { background-color: #0c125a; border-left: none; color: #fff; }
        .bootstrap-table .table:not(.table-condensed), .bootstrap-table .table:not(.table-condensed) > tbody > tr > td, .bootstrap-table .table:not(.table-condensed) > tbody > tr > th, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > td, .bootstrap-table .table:not(.table-condensed) > tfoot > tr > th, .bootstrap-table .table:not(.table-condensed) > thead > tr > td { padding: 5px; }
        .bootstrap-table .table > thead > tr > th { vertical-align: middle; border-left: 1px solid #ddd; }
    td { text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
    .fixed-table-container tbody td .th-inner, .fixed-table-container thead th .th-inner { padding: 8px; line-height: 16px; vertical-align: top; overflow: hidden; text-overflow: ellipsis; white-space: inherit; text-align: center; }
</style>
<div class="container-fluid">
    <div class="row" style="margin: 10px;">
        <div class="col-xs-3"><h4><i>经销商使用情况</i></h4></div>
        <div class="col-xs-5">
            <div class="form-inline form-group">
                <span for="days">未登录天数:</span>
                <div class="form-group">
                    <span class="input-daterange input-group" style="width:100px;">
                        <input type="text" class="input-sm form-control" id="days" />
                        <span class="input-group-addon" style="font-size:12px;">天</span>
                    </span>
                </div>
                <span style="color:#910606;">红色标注</span>
            </div>
        </div>
        <div class="col-xs-4">
            <button type="button" class="btn btn-primary btn-sm btn-search">重新查询</button>
            <button type="button" class="btn btn-primary btn-sm btn-cache">清除缓存</button>
        </div>
        <div class="col-xs-offset-8 col-xs-4">默认缓存数据12小时，如需最新数据请先清除缓存再查询</div>
    </div>
    <div class="row" style="border: 1px solid #d7d7d7; margin: 10px; padding: 5px; box-shadow: 2px 2px 5px rgba(188, 188, 188, 0.349019607843137)">
        <div class="col-xs-2">
            <div style="height: 130px;text-align:center;">
                <span id="totalWsNumberValue" style="font-size: 55px; color: #ffb11b; line-height: 100px;font-weight:bold;font-family:'Times New Roman'">0</span>
                <br />
                <span id="totolWsNumberLabel" style="font-size: 12px;font-weight:bold; line-height: 30px;">经销商总数</span>
            </div>
        </div>
        <div class="col-xs-2">
            <div style="height: 130px;text-align:center;">
                <span id="totalUserNumberValue" style="font-size: 55px; color: #73BF00; line-height: 100px;font-weight:bold;font-family:'Times New Roman'">0</span>
                <br />
                <span id="totalUserNumberLabel" style="font-size: 12px;font-weight:bold; line-height: 30px;">用户总数</span>
            </div>
        </div>
        <div class="col-xs-2">
            <div style="height: 130px;text-align:center;">
                <span id="totalVehNumberValue" style="font-size: 55px; color: #c009ca; line-height: 100px;font-weight:bold;font-family:'Times New Roman'">0</span>
                <br />
                <span id="totalVehNumberLabel" style="font-size: 12px;font-weight:bold; line-height: 30px;">GPS车辆总数</span>
            </div>
        </div>
        <div class="col-xs-6">
            <div id="moduleUserCount" style="height: 100px; padding: 3px 0px 3px 0px"></div>
            <div style="font-size: 12px;font-weight:bold; line-height: 30px;text-align:center;">各模块使用用户数 【由于一个用户可能对应多个模块，用户数之和可能大于总用户数】</div>
        </div>
    </div>

    <div class="row" style="margin: 10px;">
        <table class="table table-striped" id="table"></table>
    </div>

</div>


<script>
    $(function () {
        $this = this;
        var GetDateStr = null;
        var totalValue = {};
        var data = [];
        var $table = null;
        var totalCount = {}
        var columns = [
                [{
                    field: 'id',
                    title: '序号',
                    align: 'center',
                    width: 50,
                    colspan: 1,
                    rowspan: 2,
                    valign: "middle",
                }, {
                    field: 'AreaName',
                    title: '城市',
                    align: 'left',
                    colspan: 1,
                    rowspan: 2,
                    width: 150,
                    valign: "middle",
                }, {
                    field: 'WSID',
                    title: '经销商ID',
                    align: 'left',
                    colspan: 1,
                    rowspan: 2,
                    width: 70,
                    valign: "middle",
                }, {
                    field: 'WSName',
                    title: '经销商名称',
                    align: 'left',
                    colspan: 1,
                    rowspan: 2,
                    width: 200,
                    valign: "middle",
                }, {
                    field: 'onlineDate',
                    title: '上线日期',
                    colspan: 1,
                    rowspan: 2,
                    width: 90,
                    valign: "middle",
                    formatter: function (value, row, index) {
                        if (value == null) {
                            return "待上线";
                        } else {
                            return new Date(eval('new ' + value.substr(1, value.length - 2))).Format("yyyy-MM-dd");
                        }
                    },
                    cellStyle: function (value, row, field) {
                        if (value == null) {
                            return { css: { "background-color": "#b3c0f1", "text-align": "center" } };
                        } else {
                            return { css: { "text-align": "right" } };
                        }
                    }
                }, {
                    field: 'userCount',
                    title: '用户数',
                    halign: "center",
                    align: 'right',
                    valign: "middle",
                    colspan: 1,
                    rowspan: 2,
                    width: 70,
                    formatter: function (value, row, index) {
                        if (value == 0) {
                            return "-";
                        } else {
                            return value;
                        }
                    }
                }, {
                    field: 'vehCount',
                    title: 'GPS<br>车辆数',
                    align: 'right',
                    colspan: 1,
                    rowspan: 2,
                    width: 70,
                    valign: "middle",
                    formatter: function (value, row, index) {
                        if (value == 0) {
                            return "-";
                        } else {
                            return value;
                        }
                    },
                },
                {
                    field: 'nousedays',
                    title: '最近连续天数',
                    align: 'right',
                    halign: "center",
                    width: 300,
                    colspan: 5,
                    rowspan: 1,
                },
                {
                    field: 'usenumbers',
                    title: '各类型人数',
                    align: 'right',
                    halign: "center",
                    width: 290,
                    colspan: 7,
                    rowspan: 1,
                }
                ],
                [
                    {
                        field: 'noLoginWebDayNums',
                        title: '<i class="fa fa-television fa-lg"></i><br>未登录',
                        align: 'right',
                        formatter: function (value, row, index) {
                            if (value == null) {
                                return "-";
                            } else {
                                return "<div title='最近登录时间为：" + new Date(eval('new ' + row.noLoginWebDay.substr(1, row.noLoginWebDay.length - 2))).Format("yyyy-MM-dd") + "'>" + value + "</div>";
                            }                            
                        },
                        cellStyle: function (value, row, field) {
                            if (value == null) {
                                return { css: { "background-color": "#9b9898" } };
                            } else {
                                if (Number(value) > Number($("#days").val())) {
                                    return { css: { "background-color": "#910606", "color": "#fff" } };
                                }
                            }
                            return "";
                        }
                    }, {
                        field: 'noOrderDayNums',
                        title: '<i class="fa fa-file-text fa-lg"></i><br>未下单',
                        align: 'right',
                        formatter: function (value, row, index) {
                            if (value == null) {
                                return "-";
                            } else {
                                return "<div title='最近下单时间为：" + new Date(eval('new ' + row.OrderDate.substr(1, row.OrderDate.length - 2))).Format("yyyy-MM-dd") + "'>" + value + "</div>";
                            }
                        },
                        cellStyle: function (value, row, field) {
                            if (value == null) {
                                return { css: { "background-color": "#9b9898" } };
                            } else {
                                if (Number(value) > Number($("#days").val())) {
                                    return { css: { "background-color": "#910606", "color": "#fff" } };
                                }
                            }
                            return "";
                        }
                    }, {
                        field: 'noLoginAppDayNums',
                        title: '<i class="fa fa-tablet fa-lg"></i><br>未登录',
                        align: 'right',
                        formatter: function (value, row, index) {
                            if (value == null) {
                                return "-";
                            } else {
                                return "<div title='最近登录时间为：" + new Date(eval('new ' + row.noLoginAppDay.substr(1, row.noLoginAppDay.length - 2))).Format("yyyy-MM-dd") + "'>" + value + "</div>";
                            }
                        },
                        cellStyle: function (value, row, field) {
                            if (value == null) {
                                return { css: { "background-color": "#9b9898" } };
                            } else {
                                if (Number(value) > Number($("#days").val())) {
                                    return { css: { "background-color": "#910606", "color": "#fff" } };
                                }
                            }

                            return "";
                        }
                    }, {
                        field: 'noInputFyDayNums',
                        title: '<i class="fa fa fa-edit fa-lg"></i><br>未录费用',
                        align: 'right',
                        formatter: function (value, row, index) {
                            if (value == null) {
                                return "-";
                            } else {
                                return "<div title='最近录入时间为：" + new Date(eval('new ' + row.RecTimestamp.substr(1, row.RecTimestamp.length - 2))).Format("yyyy-MM-dd") + "'>" + value + "</div>";
                            }
                        },
                        cellStyle: function (value, row, field) {
                            if (value == null) {
                                return { css: { "background-color": "#9b9898" } };
                            } else {
                                if (Number(value) > Number($("#days").val())) {
                                    return { css: { "background-color": "#910606", "color": "#fff" } };
                                }
                            }

                            return "";
                        }
                    }, {
                        field: 'noBfDayNums',
                        title: '<i class="fa fa-user-times fa-lg"></i><br>未拜访',
                        align: 'right',
                        formatter: function (value, row, index) {
                            if (value == null) {
                                return "-";
                            } else {
                                return "<div title='最近拜访时间为：" + new Date(eval('new ' + row.VisitDate.substr(1, row.VisitDate.length - 2))).Format("yyyy-MM-dd") + "'>" + value + "</div>";
                            }
                        },
                        cellStyle: function (value, row, field) {
                            if (value == null) {
                                return { css: { "background-color": "#9b9898" } };
                            } else {
                                if (Number(value) > Number($("#days").val())) {
                                    return { css: { "background-color": "#910606", "color": "#fff" } };
                                }
                            }

                            return "";
                        }
                    }, {
                        field: 'xsdbCount',
                        title: '销售代表',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'xszgCount',
                        title: '销售主管',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'xsjlCount',
                        title: '销售经理',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'xszjCount',
                        title: '销售总监',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'cxywyCount',
                        title: '车销代表',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'sjCount',
                        title: '司机',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }, {
                        field: 'qtCount',
                        title: '其它人员',
                        halign: "center",
                        align: 'right',
                        valign: "middle",
                        formatter: function (value, row, index) {
                            if (value == 0) {
                                return "-";
                            } else {
                                return value;
                            }
                        },
                    }
                ]

        ];
        var myChartFun = null;

        $this.init = function () {
            GetDateStr = function (AddDayCount) {
                var dd = new Date();
                dd.setDate(dd.getDate() + AddDayCount);//获取AddDayCount天后的日期
                var y = dd.getFullYear();
                var m = dd.getMonth() + 1;//获取当前月份的日期
                var d = dd.getDate();
                return y + "-" + m + "-" + d;
            }

            $("#days").val(1);

            $(".btn-search").click(function () {
                $this.TableDataInit();
            })

            $(".btn-cache").click(function () {
                $.ajax({
                    type: 'POST',
                    async:false,
                    url: 'ClearCacheData',
                    beforeSend: function (XMLHttpRequest) {
                        $(".loading-icon").show();
                    },
                    success: function (result) {                        
                        alert(result);
                        $(".loading-icon").hide();
                    },
                    complete: function (XMLHttpRequest, textStatus) {
                        $(".loading-icon").hide();
                    },
                    error: function (error) {
                        //alert(error.responseText);
                    }
                });
            })

            //柱状
            myChartFun = function (myChartArr) {
                var myChart = myChartArr[0];
                var title = myChartArr[1];
                var dataLabel = myChartArr[2];
                var dataArr = myChartArr[3];

                option = {
                    title: {
                        text: "",
                        textStyle: {
                            fontSize: '12',
                            fontWeight: 'bold'
                        }
                    },
                    tooltip: {
                        trigger: 'axis',
                        axisPointer: {            // 坐标轴指示器，坐标轴触发有效
                            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
                        }
                    },
                    legend: {
                        //data: dataLabel,
                        x: 'center',
                        y: 'bottom',
                    },
                    grid: {
                        top: '15%',
                        left: '5%',
                        right: '5%',
                        bottom: '0%',
                        containLabel: true
                    },
                    xAxis:
                        {
                            type: 'category',
                            data: dataLabel,
                            boundaryGap: true,
                            axisLabel: {
                                interval: 0,
                                //rotate: 45//倾斜度 -90 至 90 默认为0
                            },
                            splitLine: {//终于找到了，背景图的内置表格中“边框”的颜色线条  这个是x跟y轴轴的线
                                show: true,
                                lineStyle: {
                                    width: 0.5,
                                    color: "#e4e4e4",
                                    type: "solid"
                                }
                            },
                            axisLine: {
                                show: false,
                                lineStyle: {
                                    width: 0.5,
                                    color: "#000000",
                                    type: "solid"
                                }
                            }
                        },
                    yAxis:
                        {
                            type: 'value',
                            splitLine: {//终于找到了，背景图的内置表格中“边框”的颜色线条  这个是x跟y轴轴的线
                                show: true,
                                lineStyle: {
                                    width: 0.5,
                                    color: "#e4e4e4",
                                    type: "solid"
                                }
                            },
                            axisLine: {
                                show: false,
                                lineStyle: {
                                    width: 0.5,
                                    color: "#000000",
                                    type: "solid"
                                }
                            },
                            axisLabel: {
                                textStyle: {
                                    color: '#999',
                                    fontSize: '9',
                                }
                            }

                        },
                    series: [
                        {
                            type: 'bar',
                            data: dataArr,
                            label: {
                                normal: {
                                    show: true,
                                    position: 'top'
                                }
                            },
                            itemStyle: {
                                normal: {
                                    color: "#00b050",//类别颜色
                                    borderColor: "#FFFFFF",
                                    borderWidth: 0
                                }
                            },

                        }
                    ]
                };
                // 使用刚指定的配置项和数据显示图表。
                myChart.setOption(option);
                $(window).resize(function () {
                    myChart.resize();
                });
            }
        }

        //$this.getDesbord = function () {
        //    //获取值
        //    $.ajax({
        //        type: 'POST',
        //        url: 'FindHelpList?fileName=优加实施售后文档.xlsx&sheetName=汇总&headerRowIndex=0',
        //        beforeSend: function (XMLHttpRequest) {
        //            $(".loading-icon").show();
        //        },
        //        success: function (data) {
        //            var result = data[0];

        //            totalValue.totalWSNumber = result.total_ws;//经销商总数
        //            totalValue.totalUSERNumber = result.total_user_number;//用户总数
        //            totalValue.numberEss = result.user_number_ess;//ESS用户数
        //            totalValue.numberElms = result.user_number_elms;//ELMS用户数
        //            totalValue.numberDms = result.user_number_dms;//DMS用户数
        //            totalValue.numberFin = result.user_number_fin;//FIN用户数
        //            totalValue.numberWpp = result.user_number_wpp;//WPP用户数
        //            totalValue.numberCust = result.user_number_cust;//自费用户数
        //            totalValue.numberTwo = result.user_number_two;//二批商用户数





        //            var totalUserNumberTypeValue = document.getElementById("totalUserNumberTypeValue");
        //            var totalUserNumberModelValue = document.getElementById("totalUserNumberModelValue");


        //            //$("#totalUserNumberTypeValue").width($("#totalUserNumberTypeValue").height()*2);
        //            //$("#totalUserNumberModelValue").width($("#totalUserNumberModelValue").height()*2);

        //            var myChart1 = echarts.init(totalUserNumberTypeValue, null, { renderer: 'svg' });
        //            var totalUserNumberTypeValueArr = new Array(myChart1, "用户数【分项目】", ["WPP", "自费", "二批"], ["#73BF00", "#cc3fc8", "#538BFA"], [totalValue.numberWpp, totalValue.numberCust, totalValue.numberTwo]);
        //            myChartFun(totalUserNumberTypeValueArr);


        //            var myChart2 = echarts.init(totalUserNumberModelValue, null, { renderer: 'svg' });
        //            var totalUserNumberModelValueArr = new Array(myChart2, "用户数【分模块】", ["DMS", "ESS", "ELMS", "财务"], ["#73BF00", "#cc3fc8", "#538BFA", "#fac753"], [totalValue.numberDms, totalValue.numberEss, totalValue.numberElms, totalValue.numberFin]);
        //            myChartFun(totalUserNumberModelValueArr);


        //            $(".loading-icon").hide();
        //        },
        //        complete: function (XMLHttpRequest, textStatus) {
        //            $(".loading-icon").hide();
        //        },
        //        error: function (error) {
        //            //alert(error.responseText);
        //        }
        //    });

        //}

        //获取值
        $this.TableDataInit = function () {
            $.ajax({
                type: 'POST',
                url: 'FindSqlList',

                data: { where: "1000095,1000225,1000142,1000147,1000247,1000175,1000220,1000216" },
                beforeSend: function (XMLHttpRequest) {
                    $(".loading-icon").show();
                },
                success: function (result) {
                    var dataLabel = [];
                    var dataArr = [];
                    result.moduleLis.map(function (item) {
                        dataLabel.push(item.ApplicationTypeName);
                        dataArr.push(item.moduleCount);
                    })

                    var moduleUserCount = document.getElementById("moduleUserCount");
                    var myChart1 = echarts.init(moduleUserCount, null);
                    var myChartArr = new Array(myChart1, "各模块对应用户数", dataLabel, dataArr);
                    myChartFun(myChartArr);


                    data = [];
                    totalCount.totalWsCount = result.totalWsCount;
                    totalCount.totalUserCount = result.totalUserCount;
                    totalCount.totalVehCount = result.totalVehCount;

                    //赋值
                    $("#totalWsNumberValue").html(totalCount.totalWsCount);
                    $("#totalUserNumberValue").html(totalCount.totalUserCount);
                    $("#totalVehNumberValue").html(totalCount.totalVehCount);

                    result.rows.map(function (item, index) {
                        var obj = {};
                        item.id = index + 1;
                        item.noLoginWebDayNums = item.noLoginWebDayNums;
                        item.noLoginAppDayNums = item.noLoginAppDayNums;
                        item.noInputFyDayNums = item.noInputFyDayNums;
                        item.noBfDayNums = item.noBfDayNums;

                        data.push(item);
                    })



                    if ($table == null) {
                        $this.tableInit();
                    } else {
                        $table.bootstrapTable('refreshOptions', {
                            data: data,
                            //height: $(window).height() - $table.offset().top - 15,
                            columns: columns,
                        });
                    }

                    $(".loading-icon").hide();
                },
                complete: function (XMLHttpRequest, textStatus) {
                    $(".loading-icon").hide();
                },
                error: function (error) {
                    //alert(error.responseText);
                }
            });
            //$.ajax({
            //    type: 'POST',
            //    url: 'FindHelpList?fileName=优加实施售后文档.xlsx&sheetName=经销商数据查询&headerRowIndex=1',
            //    beforeSend:function(XMLHttpRequest){
            //        $(".loading-icon").show();
            //    },
            //    success: function (result) {
            //        data = [];
            //        result.dbRows.map(function (item, index) {
            //            var filterExcelRows = result.excelRows.filter(function (_item) { return _item["经销商编码"] != "" && _item["经销商编码"] == item.WSID })[0];
            //            var dms = isNaN(parseFloat(filterExcelRows["DMS人数"])) ? 0 : parseFloat(filterExcelRows["DMS人数"]);
            //            var elms = isNaN(parseFloat(filterExcelRows["ELMS人数"])) ? 0 : parseFloat(filterExcelRows["ELMS人数"]);
            //            var ess = isNaN(parseFloat(filterExcelRows["ESS人数"])) ? 0 : parseFloat(filterExcelRows["ESS人数"]);
            //            var fin = isNaN(parseFloat(filterExcelRows["财务人数"])) ? 0 : parseFloat(filterExcelRows["财务人数"]);

            //            var obj = {};
            //            obj.id = index + 1;
            //            obj.bu = filterExcelRows["事业部"];
            //            obj.city = filterExcelRows["城市"];
            //            obj.WSName = filterExcelRows["经销商名称"];
            //            obj.onlineDate = item.onlineDate;//filterExcelRows["正式上线日期"];
            //            obj.dms = dms;
            //            obj.elms = elms;
            //            obj.ess = ess;
            //            obj.fin = fin;
            //            obj.noLoginWebDayNums = item.noLoginWebDay == null ? "-" : item.noLoginWebDayNums;
            //            obj.noLoginAppDayNums = item.noLoginAppDay == null ? "-" : item.noLoginAppDayNums;
            //            obj.noLoginWebDay = item.noLoginWebDay;
            //            obj.noLoginAppDay = item.noLoginAppDay;
            //            obj.noInputFyDayNums = 0;
            //            obj.noBfDayNums = 0;

            //            data.push(obj);
            //        })



            //        if ($table==null) {
            //            $this.tableInit();
            //        } else {
            //            $table.bootstrapTable('refreshOptions', {
            //                data: data,
            //                height: $(window).height() - $table.offset().top - 15,
            //                columns: columns,
            //            });
            //        }

            //        $(".loading-icon").hide();
            //    },
            //    complete: function (XMLHttpRequest, textStatus) {
            //        $(".loading-icon").hide();
            //    },
            //    error: function (error) {
            //        //alert(error.responseText);
            //    }
            //});
        }

        $this.tableInit = function () {
            $table = $('#table');
            $table.bootstrapTable({
                data: data,
                singleSelect: true,
                height: $(window).height() - $table.offset().top - 15,
                columns: columns,
                onClickRow: function (row, $element) {
                    if ($table.bootstrapTable('getOptions').singleSelect == true) {
                        $('.success').removeClass('success');//去除之前选中的行的，选中样式
                        $($element).addClass('success');//添加当前选中的 success样式用于区别
                    }
                },
            });

            $(window).resize(function () {
                $table.bootstrapTable('resetView', { height: $(window).height() - $(".table").offset().top - 15 });//随窗口变化改变高度
            })
        }


        $this.init();
        //$this.getDesbord();
        $this.TableDataInit();


    });



</script>